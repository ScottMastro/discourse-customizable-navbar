<script type="text/discourse-plugin" version="0.8">

  api.createWidget("e4-navbar", {
    tagName: "div.e4-container.e4-button",

    html() {

  const h = require("virtual-dom").h; 

  
  function isImage(url) {
     return /\.(jpg|jpeg|png|webp|avif|gif|svg)$/.test(url);
   }
  
   var strName = settings.navbar_name;
   var strURL = settings.navbar_location;

   var names = strName.split('|');
   var url = strURL.split('|');
   var is_admin = false;
   
   try {
     is_admin = Discourse.User.current().admin;
   } catch (error) {
     console.error(error);
   }
   
   function createNavbarElement(navName, navURL, notif) {

    if (notif > 0){
      return h('li', [h('a', { href: navURL }, navName),
      h("div.notification-bubble", {}, notif)]);
    }

    if (isImage(navName)){
      return h('li',
        h("a", { href: navURL },
          h("img.e4-button-image", {src: navName})));
    }

     return h('li', h('a', { href: navURL }, navName));
   }
   
      var topicTrackingState = Discourse.__container__.lookup('topic-tracking-state:main');
      var pmTopicTrackingState = Discourse.__container__.lookup('service:pm-topic-tracking-state');

      topicTrackingState.onStateChange(() => {
        this.scheduleRerender();
       });
       
       pmTopicTrackingState.onStateChange("pm-tracking-key", () => {
        console.log("WAOOOO");
        this.scheduleRerender();
       });

       const contents = [];

       for (let i = 0; i < names.length; i++) {
       
        var notif = 0;
        if (url[i].endsWith('/new') ) {  notif = topicTrackingState.countNew(); }
        if (url[i].endsWith('/unread') ) { notif = topicTrackingState.countUnread(); }
        if (url[i].endsWith('/messages') ) { 
          notif = Discourse.User.current().new_personal_messages_notifications_count; }


        if (url[i].endsWith('/admin') && !is_admin) { continue; }
        contents.push(createNavbarElement(names[i], url[i], notif))

       }
       return h('ul', {}, contents);
     }
   });
</script>
<script type="text/x-handlebars" data-template-name="/connectors/above-main-container/navbar">
  
  {{mount-widget widget="e4-navbar"}}
</script>
