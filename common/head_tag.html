<script type="text/discourse-plugin" version="0.8">
  var topicTrackingState = Discourse.__container__.lookup('topic-tracking-state:main');
  const h = require("virtual-dom").h; 
  function isImage(url) {
     return /\.(jpg|jpeg|png|webp|avif|gif|svg)$/.test(url);
   }
  
   var strName = settings.navbar_name;
   var strURL = settings.navbar_location;
     
   this.callbackId = topicTrackingState.onStateChange(() => {
    totalUnread = topicTrackingState.countUnread();
    totalNew = topicTrackingState.countNew();
    console.log(totalNew)
   });

   var names = strName.split('|');
   var url = strURL.split('|');
   var is_admin = false;
   
   try {
     is_admin = Discourse.User.current().admin;
   } catch (error) {
     console.error(error);
   }  
   
   function createNavbarElement(navName, navURL, notifs) {

    if (isImage(navName)){
      return h('li',
        h("a", { href: navURL },
          h("img.e4-button-image", {src: navName})));
    }
     
    if (notifs > 0){
      return h('li', [h('a', { href: navURL }, navName),
      h("div.notification-bubble", {}, totalNew)]);
  
    } else {
     return h('li', h('a', { href: navURL }, navName));
    }
   }
   
   api.createWidget("e4-navbar", {
     tagName: "div.e4-container.e4-button",
  
     html() {
       const contents = [];
  
       for (let i = 0; i < names.length; i++) {
       
        var notifs = 0 
        if (navURL.endsWith('/new') ) {
          notifs=attrs.new;
        }
        if (navURL.endsWith('/unread') ) { 
          notifs=attrs.unread;
        }

         if (url[i].endsWith('/admin') && !is_admin) { continue; }
         contents.push(createNavbarElement(names[i], url[i], notifs))

       }
       return h('ul', {}, contents);
     }
   });
</script>
<script type="text/x-handlebars" data-template-name="/connectors/above-main-container/navbar">

  var topicTrackingState = Discourse.__container__.lookup('topic-tracking-state:main');

  var totalUnread = topicTrackingState.countUnread();
  var totalNew = topicTrackingState.countNew();

  arguments = {"unread" : totalUnread, "new" : totalNew}
  console.log(arguments)
  {{mount-widget widget="e4-navbar", args=arguments}}
</script>
